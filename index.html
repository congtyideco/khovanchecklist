<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Vận Hành & SOP (Tối ưu theo GDP/SOP)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* Thêm tiền tố 'acc-checklist-' vào các lớp CSS tùy chỉnh */
        body { background-color: #f0f2f5; font-size: 14px; }
        .acc-checklist-dashboard { position: sticky; top: 20px; }
        .acc-checklist-status-select { font-weight: bold; }
        .acc-checklist-status-not-started { color: #dc3545; border-color: #dc3545; }
        .acc-checklist-status-in-progress { color: #ffc107; border-color: #ffc107; }
        .acc-checklist-status-completed { color: #198754; border-color: #198754; }
        #acc-checklist-reportModal .modal-body { white-space: pre-wrap; font-family: monospace; background-color: #f8f9fa; }

        .acc-checklist-floating-btn {
            background-color: #004a99;
            color: white;
            border: 2px solid white;
            border-radius: 25px;
            padding: 10px 15px;
            font-weight: bold;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
        }

        .acc-checklist-floating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.5);
        }

        .acc-checklist-floating-btn i {
            margin-right: 8px;
            font-size: 1.3rem;
        }
        
        #acc-checklist-floatingBtn {
            background-color: #dc3545;
        }

        #acc-checklist-mainAppModal .modal-dialog { max-width: 95vw; width: 1600px; }
        #acc-checklist-mainAppModal .modal-content { height: 90vh; }
        #acc-checklist-mainAppModal .modal-body { overflow-y: auto; background-color: #f8f9fa; }
        
        .acc-checklist-header-section {
            background-color: #004a99; color: white; padding: 1rem;
            border-radius: 0.5rem; margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .acc-checklist-task-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 0.5rem;
        }
        .acc-checklist-task-card .card-header { font-weight: bold; font-size: 1.2rem; }
        .acc-checklist-notes-input { width: 100%; border: 1px solid #eee; padding: 5px; border-radius: 4px; }

        .acc-checklist-delete-btn { opacity: 0.5; transition: opacity 0.2s; }
        .list-group-item:hover .acc-checklist-delete-btn { opacity: 1; }
        .btn-loading .spinner-border { width: 1rem; height: 1rem; }

        .container {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }

        .text-primary {
            color: #004a99 !important;
        }

        .rounded {
            border-radius: 0.5rem !important;
        }

        .shadow {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        /* Các lớp CSS mới cho tính năng chỉnh sửa */
        .acc-checklist-editable {
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .acc-checklist-editable:hover {
            background-color: rgba(0, 74, 153, 0.1);
        }
        
        .acc-checklist-edit-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #004a99;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .acc-checklist-edit-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .acc-checklist-edit-buttons button {
            font-size: 12px;
            padding: 2px 8px;
        }
        
        .acc-checklist-task-name {
            word-break: break-word;
        }
        
        .acc-checklist-notes-validation {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="container text-center py-5">
        <h1 class="mb-4 text-primary">VẬN HÀNH HIỆU QUẢ - GIAO NHẬN CHUYÊN NGHIỆP - TẠO RA GIÁ TRỊ!</h1>
        <div class="d-flex justify-content-center">
            <img src="https://cdn.imgpile.com/f/im0vJIV_xl.png" alt="Giao diện đẹp" class="img-fluid rounded shadow" style="max-width: 80%; height: auto;">
        </div>
    </div>

    <div style="position: fixed; top: 60px; left: 20px; z-index: 1040; display: flex; flex-direction: column; gap: 10px;">
        <a href="https://erp-ideco.skyit.vn/#/app/dashboard/main" style="text-decoration: none;">
            <button id="acc-checklist-erpBtn" class="acc-checklist-floating-btn">
                <i class="bi bi-house-door-fill"></i> ERP HOME
            </button>
        </a>
        <button id="acc-checklist-floatingBtn" class="acc-checklist-floating-btn" data-bs-toggle="modal" data-bs-target="#acc-checklist-selectionModal">
            <i class="bi bi-card-checklist"></i> Checklist Công việc
        </button>
    </div>
    
    <div class="modal fade" id="acc-checklist-selectionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-check-fill"></i> Bảng Chọn Checklist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Chọn loại checklist bạn muốn quản lý:</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="showCoordinatorSelection()">
                            <i class="bi bi-box-seam"></i> Kho & Giao nhận
                        </button>
                        <button class="btn btn-outline-success" onclick="showSOPSelection()">
                            <i class="bi bi-clipboard-check"></i> Phụ trách SOP
                        </button>
                    </div>
                    <hr>
                    <div id="acc-checklist-accountantList" class="list-group" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="acc-checklist-mainAppModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                 <div class="modal-header bg-light">
                    <h5 class="modal-title text-primary" id="acc-checklist-mainAppModalLabel"></h5>
                    <button type="button" class="btn btn-outline-secondary btn-sm me-auto ms-4" onclick="backToSelection()">
                        <i class="bi bi-arrow-left-right"></i> Quay lại Bảng Chọn
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="header-section acc-checklist-header-section text-center">
                            <h2 id="acc-checklist-mainTitle"></h2>
                            <h5 id="acc-checklist-currentMonth"></h5>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <div class="card acc-checklist-dashboard">
                                    <div class="card-header bg-dark text-white"><i class="bi bi-speedometer2"></i> Bảng Điều Khiển</div>
                                    <div class="card-body">
                                        <h5>Tổng Quan Tiến Độ</h5>
                                        <div class="progress" style="height: 30px;"><div id="acc-checklist-totalProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%; font-size: 1rem;">0%</div></div>
                                        <hr>
                                        <div id="acc-checklist-summary">
                                            <p class="mb-1"><strong>Tổng số công việc:</strong> <span id="acc-checklist-totalTasks">0</span></p>
                                            <p class="mb-1 text-success"><strong><i class="bi bi-check-circle-fill"></i> Hoàn thành:</strong> <span id="acc-checklist-completedTasks">0</span></p>
                                            <p class="mb-1 text-warning"><strong><i class="bi bi-play-circle-fill"></i> Đang làm:</strong> <span id="acc-checklist-inProgressTasks">0</span></p>
                                            <p class="mb-1 text-danger"><strong><i class="bi bi-x-circle-fill"></i> Chưa làm:</strong> <span id="acc-checklist-notStartedTasks">0</span></p>
                                        </div>
                                        <hr>
                                        <div class="d-grid">
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#acc-checklist-reportModal"><i class="bi bi-file-earmark-text"></i> Tạo Báo Cáo Nhanh</button>
                                        </div>
                                        <div class="d-grid mt-3">
                                            <button class="btn btn-warning" onclick="confirmRefreshChecklist()"><i class="bi bi-arrow-clockwise"></i> Làm mới kỳ mới</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-9">
                                <div id="acc-checklist-taskList"></div>
                                <div class="d-flex justify-content-end mt-3">
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#acc-checklist-addTaskModal"><i class="bi bi-plus-circle"></i> Thêm Công Việc Mới</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="acc-checklist-newAccountantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="acc-checklist-newModalTitle">Tạo Checklist Mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label for="acc-checklist-newAccountantNameInput" class="form-label" id="acc-checklist-newModalLabel">Nhập tên người phụ trách:</label>
                    <input type="text" id="acc-checklist-newAccountantNameInput" class="form-control" placeholder="Ví dụ: Nguyễn Văn A">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" id="acc-checklist-saveNewAccountantBtn" class="btn btn-primary" onclick="createNewChecklist()">Lưu và Bắt đầu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="acc-checklist-addTaskModal" tabindex="-1" aria-labelledby="acc-checklist-addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="acc-checklist-addTaskModalLabel">Thêm Công Việc Mới</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="acc-checklist-addTaskForm">
                        <div class="mb-3"><label for="acc-checklist-taskName" class="form-label">Tên công việc</label><input type="text" class="form-control" id="acc-checklist-taskName" required></div>
                        <div class="mb-3">
                            <label for="acc-checklist-taskCategory" class="form-label">Phân loại</label>
                            <select class="form-select" id="acc-checklist-taskCategory" required>
                                </select>
                        </div>
                        <div class="mb-3"><label for="acc-checklist-taskDeadline" class="form-label">Hạn chót (Tùy chọn)</label><input type="date" class="form-control" id="acc-checklist-taskDeadline"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="addTask()">Thêm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="acc-checklist-reportModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Báo Cáo Nhanh Tiến Độ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="acc-checklist-reportContent"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary" onclick="copyReport()"><i class="bi bi-clipboard"></i> Sao chép</button></div></div></div></div>

    <!-- Modal xác nhận xóa checklist -->
    <div class="modal fade" id="acc-checklist-deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Xác nhận xóa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="acc-checklist-deleteMessage">Bạn có chắc chắn muốn xóa checklist này không?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger" id="acc-checklist-confirmDeleteBtn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal yêu cầu ghi chú khi hoàn thành -->
    <div class="modal fade" id="acc-checklist-completionNotesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill text-success"></i> Hoàn thành công việc</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Vui lòng cung cấp ghi chú về việc hoàn thành công việc này (ít nhất 20 ký tự):</p>
                    <textarea class="form-control" id="acc-checklist-completionNotes" rows="4" placeholder="Mô tả chi tiết về việc hoàn thành công việc..."></textarea>
                    <div class="acc-checklist-notes-validation" id="acc-checklist-notesValidation"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="acc-checklist-saveCompletionBtn">Lưu và hoàn thành</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBD8aIBY5OARTj4TfhhzoasImK0CkXqGGY",
        authDomain: "khovanchecklist.firebaseapp.com",
        databaseURL: "https://khovanchecklist-default-rtdb.firebaseio.com",
        projectId: "khovanchecklist",
        storageBucket: "khovanchecklist.firebasestorage.app",
        messagingSenderId: "121586948526",
        appId: "1:121586948526:web:0eeaf64baf45401563103f",
        measurementId: "G-PR6DFBR6PW"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentCoordinatorId = null;
    let currentChecklistData = null;
    let checklistType = null; // 'coordinator' or 'sop'
    let selectionModal, mainAppModal, newAccountantModal, addTaskModal, deleteConfirmModal, completionNotesModal;
    let currentEditingTaskId = null;
    let currentTaskForCompletion = null;

    const initialTasksCoordinator = [
        { id: 1, category: 'Đầu kỳ - Chuẩn bị', name: 'Kiểm kê tồn kho đầu kỳ và đối chiếu số liệu', status: 'not-started', notes: '', deadline: '' },
        { id: 2, category: 'Đầu kỳ - Chuẩn bị', name: 'Rà soát danh sách khách hàng, tuyến giao hàng, khu vực', status: 'not-started', notes: '', deadline: '' },
        { id: 3, category: 'Trong kỳ - Điều phối & Xuất hàng', name: 'Thực hiện điều phối nhận hàng trong ngày/tuần - yêu cầu gợi phiếu xuất hàng trước', status: 'not-started', notes: 'Ưu tiên đơn hàng có yêu cầu gấp hoặc giao xa', deadline: '' },
        { id: 4, category: 'Trong kỳ - Điều phối & Xuất hàng', name: 'Thực hiện phối hợp kiểm tra- khai thủ tục nhập kho hàng trong tuần / chứng từ nhập kho', status: 'not-started', notes: 'Sử dụng túi giữ nhiệt cho hàng lạnh', deadline: '' },
        { id: 5, category: 'Trong kỳ - Điều phối & Xuất hàng', name: 'Thực hiện việc kiểm hàng - nhập dữ liệu đóng gói - giao nhận phát sinh ngày', status: 'not-started', notes: '', deadline: '' },
        { id: 6, category: 'Trong kỳ - Giao hàng & Thu tiền', name: 'Thực hiện kiểm tra tình trạng đơn hàng chuẩn bị giao: phiếu xuất kho - in tem nhãn giao nhận', status: 'not-started', notes: 'Ghi rõ giờ giao, ký nhận', deadline: '' },
        { id: 7, category: 'Trong kỳ - Giao hàng & Thu tiền', name: 'Thực hiện công tác giao hàng trong ngày - nhập liệu giao hàng - kiểm tra giao hàng', status: 'not-started', notes: 'Đối chiếu và ký xác nhận', deadline: '' },
        { id: 8, category: 'Trong kỳ - Giao hàng & Thu tiền', name: 'Thực hiện công tác thu tiền- kiểm tra đối soát thu tiên- thông báo đến kế toán-BGĐ', status: 'not-started', notes: 'Theo dõi mã vận đơn, tình trạng đơn hàng', deadline: '' },
        { id: 9, category: 'Trong kỳ - Giao hàng & Thu tiền', name: 'Giải quyết các vấn đề phát sinh từ khách hàng (hủy đơn, đổi trả...)', status: 'not-started', notes: '', deadline: '' },
        { id:10, category: 'Trong kỳ - Giao hàng & Thu tiền', name: 'Thực hiện nhiệm vụ giao trong tuần theo định hướng/ phát sinh liên quan đến kho - giao nhận', status: 'not-started', notes: '', deadline: '' },
        { id: 11, category: 'Cuối kỳ - Báo cáo & Tổng kết', name: 'Thực hiện đối chiếu số liệu kho - kiểm kho -sắp xếp lại kho ', status: 'not-started', notes: '', deadline: '' },
        { id: 12, category: 'Cuối kỳ - Báo cáo & Tổng kết', name: 'Kiểm tra và sắp xếp chứng từ, hóa đơn giao nhận', status: 'not-started', notes: 'Lưu trữ theo tháng', deadline: '' },
        { id: 13, category: 'Cuối kỳ - Báo cáo & Tổng kết', name: 'Kiểm tra và báo cáo điều kiện bảo quản kho (nhiệt độ, độ ẩm)/ khai báo giao nhận vào form', status: 'not-started', notes: '', deadline: '' },
        { id: 14, category: 'Cuối kỳ - Báo cáo & Tổng kết', name: 'Báo cáo KPI - cập nhật số liệu trong kỳ: in - lưu chứng từ kho định kỳ', status: 'not-started', notes: '', deadline: '' }
    ];

    const initialTasksSOP = [
        { id: 1, category: 'Hàng ngày', name: 'Kiểm tra các thủ tục quy trình phát sinh trong xuất -nhập thuốc -báo cáo', status: 'not-started', notes: '', deadline: '' },
        { id: 2, category: 'Hàng ngày', name: 'Giám sát quá trình đóng gói và vận chuyển', status: 'not-started', notes: 'Đảm bảo thuốc được giao đúng cách', deadline: '' },
        { id: 3, category: 'Hàng tuần', name: 'Kiểm tra / khai báo việc giám sát nhiệt độ -độ ẩm kho- lưu dữ liệu trong máy', status: 'not-started', notes: 'Đảm bảo các điều kiện luôn nằm trong giới hạn cho phép', deadline: '' },
        { id: 4, category: 'Hàng tuần', name: 'Xử lý các sai lệch điều kiện bảo quản nếu có', status: 'not-started', notes: '', deadline: '' },
        { id: 5, category: 'Hàng tuần', name: 'Kiểm tra - đánh giá danh mục thuốc kinh doanh định kỳ - báo cáo BGD', status: 'not-started', notes: '', deadline: '' },
        { id: 6, category: 'Hàng tuần', name: 'Giải quyết các sự cố, khiếu nại liên quan đến chất lượng thuốc', status: 'not-started', notes: '', deadline: '' },
        { id: 7, category: 'Hàng tuần', name: 'Tổng hợp - xử lý các thủ tục khai form quản lý quy trình thuốc định kỳ', status: 'not-started', notes: '', deadline: '' },
        { id: 8, category: 'Hàng tuần', name: 'Báo cáo công tác theo dõi SOP định kỳ tuần/ tháng', status: 'not-started', notes: '', deadline: '' }
    ];
    
    document.addEventListener('DOMContentLoaded', () => {
        selectionModal = new bootstrap.Modal(document.getElementById('acc-checklist-selectionModal'));
        mainAppModal = new bootstrap.Modal(document.getElementById('acc-checklist-mainAppModal'));
        newAccountantModal = new bootstrap.Modal(document.getElementById('acc-checklist-newAccountantModal'));
        addTaskModal = new bootstrap.Modal(document.getElementById('acc-checklist-addTaskModal'));
        deleteConfirmModal = new bootstrap.Modal(document.getElementById('acc-checklist-deleteConfirmModal'));
        completionNotesModal = new bootstrap.Modal(document.getElementById('acc-checklist-completionNotesModal'));
        
        document.getElementById('acc-checklist-selectionModal').addEventListener('shown.bs.modal', resetSelectionView);
        
        // Thiết lập sự kiện cho modal hoàn thành
        document.getElementById('acc-checklist-saveCompletionBtn').addEventListener('click', saveCompletionWithNotes);
        document.getElementById('acc-checklist-completionNotes').addEventListener('input', validateCompletionNotes);
    });

    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Đang xử lý...`;
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText;
        }
    }

    function resetSelectionView() {
        const listDiv = document.getElementById('acc-checklist-accountantList');
        listDiv.innerHTML = '<p class="text-center text-muted p-3">Chọn loại checklist bạn muốn quản lý ở trên.</p>';
    }

    async function loadCoordinatorList() {
        const listDiv = document.getElementById('acc-checklist-accountantList');
        listDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;
        try {
            const snapshot = await database.ref('checklists/coordinator').once('value');
            const data = snapshot.val();
            listDiv.innerHTML = '<button class="btn btn-success mb-3" onclick="openNewAccountantModal(\'coordinator\')"><i class="bi bi-plus-circle"></i> Tạo Checklist Mới</button>';
            if (data) {
                Object.values(data).forEach(acc => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <a href="#" class="text-decoration-none text-dark flex-grow-1" onclick="event.preventDefault(); loadChecklistFor('${acc.id}', 'coordinator')">
                            <strong>${acc.coordinatorName}</strong>
                            <br><small class="text-muted">Ngày lập: ${acc.creationDate}</small>
                        </a>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editChecklistName('${acc.id}', '${acc.coordinatorName}', 'coordinator')"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-outline-danger btn-sm acc-checklist-delete-btn" onclick="confirmDeleteCoordinator('${acc.id}', '${acc.coordinatorName}', 'coordinator')"><i class="bi bi-trash-fill"></i></button>
                        </div>`;
                    listDiv.appendChild(item);
                });
            } else {
                listDiv.innerHTML += '<p class="text-center text-muted p-3">Chưa có checklist nào.</p>';
            }
        } catch (error) {
            console.error("Lỗi:", error);
            listDiv.innerHTML = '<p class="text-center text-danger p-3">Lỗi kết nối CSDL.</p>';
        }
    }

    async function loadSOPList() {
        const listDiv = document.getElementById('acc-checklist-accountantList');
        listDiv.innerHTML = `<div class="text-center p-3"><div class="spinner-border text-primary"></div></div>`;
        try {
            const snapshot = await database.ref('checklists/sop').once('value');
            const data = snapshot.val();
            listDiv.innerHTML = '<button class="btn btn-success mb-3" onclick="openNewAccountantModal(\'sop\')"><i class="bi bi-plus-circle"></i> Tạo Checklist Mới</button>';
            if (data) {
                Object.values(data).forEach(acc => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    item.innerHTML = `
                        <a href="#" class="text-decoration-none text-dark flex-grow-1" onclick="event.preventDefault(); loadChecklistFor('${acc.id}', 'sop')">
                            <strong>${acc.coordinatorName}</strong>
                            <br><small class="text-muted">Ngày lập: ${acc.creationDate}</small>
                        </a>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary btn-sm" onclick="editChecklistName('${acc.id}', '${acc.coordinatorName}', 'sop')"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn btn-outline-danger btn-sm acc-checklist-delete-btn" onclick="confirmDeleteCoordinator('${acc.id}', '${acc.coordinatorName}', 'sop')"><i class="bi bi-trash-fill"></i></button>
                        </div>`;
                    listDiv.appendChild(item);
                });
            } else {
                listDiv.innerHTML += '<p class="text-center text-muted p-3">Chưa có checklist nào.</p>';
            }
        } catch (error) {
            console.error("Lỗi:", error);
            listDiv.innerHTML = '<p class="text-center text-danger p-3">Lỗi kết nối CSDL.</p>';
        }
    }

    function showCoordinatorSelection() {
        checklistType = 'coordinator';
        loadCoordinatorList();
    }

    function showSOPSelection() {
        checklistType = 'sop';
        loadSOPList();
    }

    function openNewAccountantModal(type) {
        checklistType = type;
        const modalTitle = document.getElementById('acc-checklist-newModalTitle');
        const modalLabel = document.getElementById('acc-checklist-newModalLabel');
        if (type === 'coordinator') {
            modalTitle.innerText = 'Tạo Checklist Kho & Giao nhận';
            modalLabel.innerText = 'Nhập tên người phụ trách kho:';
        } else {
            modalTitle.innerText = 'Tạo Checklist Phụ trách SOP';
            modalLabel.innerText = 'Nhập tên người phụ trách SOP:';
        }
        document.getElementById('acc-checklist-newAccountantNameInput').value = '';
        newAccountantModal.show();
    }

    async function createNewChecklist() {
        const nameInput = document.getElementById('acc-checklist-newAccountantNameInput');
        const name = nameInput.value.trim();
        const saveBtn = document.getElementById('acc-checklist-saveNewAccountantBtn');
        if (!name) { alert('Vui lòng nhập tên.'); return; }
        setButtonLoading(saveBtn, true);
        try {
            const coordinatorId = slugify(name);
            const ref = database.ref(`checklists/${checklistType}/${coordinatorId}`);
            const snapshot = await ref.once('value');
            if (snapshot.exists()) {
                alert('Tên này đã tồn tại.');
                return;
            }
            const initialTasks = (checklistType === 'coordinator') ? initialTasksCoordinator : initialTasksSOP;
            const newChecklist = {
                id: coordinatorId, coordinatorName: name,
                creationDate: new Date().toLocaleDateString('vi-VN'),
                tasks: JSON.parse(JSON.stringify(initialTasks))
            };
            await ref.set(newChecklist);
            newAccountantModal.hide();
            loadChecklistFor(coordinatorId, checklistType);
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi tạo mới.");
        } finally {
            setButtonLoading(saveBtn, false);
        }
    }
    
    async function loadChecklistFor(coordinatorId, type) {
        checklistType = type;
        try {
            const snapshot = await database.ref(`checklists/${checklistType}/${coordinatorId}`).once('value');
            currentChecklistData = snapshot.val();
            if (currentChecklistData) {
                currentCoordinatorId = coordinatorId;
                document.getElementById('acc-checklist-mainAppModalLabel').innerHTML = `<i class="bi bi-person-fill"></i> Checklist của: <strong>${currentChecklistData.coordinatorName}</strong> <button class="btn btn-outline-primary btn-sm ms-2" onclick="editChecklistName('${currentCoordinatorId}', '${currentChecklistData.coordinatorName}', '${checklistType}')"><i class="bi bi-pencil-fill"></i> Sửa tên</button>`;
                document.getElementById('acc-checklist-mainTitle').innerHTML = `<i class="bi bi-person-fill"></i> Checklist của: <strong>${currentChecklistData.coordinatorName}</strong>`;
                document.getElementById('acc-checklist-currentMonth').innerHTML = `<i class="bi bi-calendar-check"></i> Tháng ${new Date().getMonth() + 1}/${new Date().getFullYear()}`;
                selectionModal.hide();
                renderTaskList();
                mainAppModal.show();
            } else {
                alert("Không tìm thấy dữ liệu.");
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi tải dữ liệu.");
        }
    }

    function renderTaskList() {
        const taskListDiv = document.getElementById('acc-checklist-taskList');
        taskListDiv.innerHTML = '';
        if (!currentChecklistData.tasks || currentChecklistData.tasks.length === 0) {
            taskListDiv.innerHTML = '<p class="text-center text-muted p-4">Chưa có công việc nào.</p>';
            updateDashboard();
            return;
        }
        const categories = [...new Set(currentChecklistData.tasks.map(task => task.category))];
        categories.forEach(category => {
            const categoryTasks = currentChecklistData.tasks.filter(task => task.category === category);
            const card = document.createElement('div');
            card.className = 'card acc-checklist-task-card';
            card.innerHTML = `
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-folder-fill"></i> ${category}</span>
                    <span class="badge bg-light text-dark">${categoryTasks.length} công việc</span>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        ${categoryTasks.map(task => `
                            <li class="list-group-item d-flex justify-content-between align-items-start">
                                <div class="ms-2 me-auto flex-grow-1">
                                    <div class="fw-bold acc-checklist-task-name">
                                        <span class="acc-checklist-editable" onclick="editTaskName(${task.id})">${task.name}</span>
                                        ${task.deadline ? `<br><small class="text-muted"><i class="bi bi-calendar-event"></i> Hạn: ${task.deadline}</small>` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <textarea class="form-control acc-checklist-notes-input" placeholder="Ghi chú..." onchange="updateTaskNotes(${task.id}, this.value)">${task.notes || ''}</textarea>
                                    </div>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <div class="btn-group mb-2">
                                        <button class="btn btn-sm ${task.status === 'not-started' ? 'btn-outline-danger' : task.status === 'in-progress' ? 'btn-warning' : 'btn-success'} dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            ${task.status === 'not-started' ? '<i class="bi bi-x-circle"></i> Chưa làm' : task.status === 'in-progress' ? '<i class="bi bi-play-circle"></i> Đang làm' : '<i class="bi bi-check-circle"></i> Hoàn thành'}
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="updateTaskStatus(${task.id}, 'not-started')"><i class="bi bi-x-circle text-danger"></i> Chưa làm</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="updateTaskStatus(${task.id}, 'in-progress')"><i class="bi bi-play-circle text-warning"></i> Đang làm</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="showCompletionNotesModal(${task.id})"><i class="bi bi-check-circle text-success"></i> Hoàn thành</a></li>
                                        </ul>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm acc-checklist-delete-btn" onclick="deleteTask(${task.id})"><i class="bi bi-trash-fill"></i> Xóa</button>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
            taskListDiv.appendChild(card);
        });
        updateDashboard();
    }

    function updateDashboard() {
        if (!currentChecklistData.tasks || currentChecklistData.tasks.length === 0) {
            document.getElementById('acc-checklist-totalProgressBar').style.width = '0%';
            document.getElementById('acc-checklist-totalProgressBar').innerText = '0%';
            document.getElementById('acc-checklist-totalTasks').innerText = '0';
            document.getElementById('acc-checklist-completedTasks').innerText = '0';
            document.getElementById('acc-checklist-inProgressTasks').innerText = '0';
            document.getElementById('acc-checklist-notStartedTasks').innerText = '0';
            return;
        }
        const totalTasks = currentChecklistData.tasks.length;
        const completedTasks = currentChecklistData.tasks.filter(task => task.status === 'completed').length;
        const inProgressTasks = currentChecklistData.tasks.filter(task => task.status === 'in-progress').length;
        const notStartedTasks = currentChecklistData.tasks.filter(task => task.status === 'not-started').length;
        const progressPercentage = Math.round((completedTasks / totalTasks) * 100);
        document.getElementById('acc-checklist-totalProgressBar').style.width = `${progressPercentage}%`;
        document.getElementById('acc-checklist-totalProgressBar').innerText = `${progressPercentage}%`;
        document.getElementById('acc-checklist-totalTasks').innerText = totalTasks;
        document.getElementById('acc-checklist-completedTasks').innerText = completedTasks;
        document.getElementById('acc-checklist-inProgressTasks').innerText = inProgressTasks;
        document.getElementById('acc-checklist-notStartedTasks').innerText = notStartedTasks;
    }

    async function updateTaskStatus(taskId, newStatus) {
        try {
            const taskIndex = currentChecklistData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                currentChecklistData.tasks[taskIndex].status = newStatus;
                await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
                renderTaskList();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi cập nhật trạng thái.");
        }
    }

    async function updateTaskNotes(taskId, notes) {
        try {
            const taskIndex = currentChecklistData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                currentChecklistData.tasks[taskIndex].notes = notes;
                await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi cập nhật ghi chú.");
        }
    }

    function showCompletionNotesModal(taskId) {
        currentTaskForCompletion = taskId;
        document.getElementById('acc-checklist-completionNotes').value = '';
        document.getElementById('acc-checklist-notesValidation').textContent = '';
        completionNotesModal.show();
    }

    function validateCompletionNotes() {
        const notes = document.getElementById('acc-checklist-completionNotes').value;
        const validationElement = document.getElementById('acc-checklist-notesValidation');
        
        if (notes.length < 20) {
            validationElement.textContent = `Ghi chú phải có ít nhất 20 ký tự (hiện tại: ${notes.length}/20)`;
            document.getElementById('acc-checklist-saveCompletionBtn').disabled = true;
        } else {
            validationElement.textContent = '';
            document.getElementById('acc-checklist-saveCompletionBtn').disabled = false;
        }
    }

    async function saveCompletionWithNotes() {
        const notes = document.getElementById('acc-checklist-completionNotes').value;
        
        if (notes.length < 20) {
            alert('Ghi chú phải có ít nhất 20 ký tự. Vui lòng nhập đầy đủ thông tin.');
            return;
        }
        
        try {
            const taskIndex = currentChecklistData.tasks.findIndex(task => task.id === currentTaskForCompletion);
            if (taskIndex !== -1) {
                currentChecklistData.tasks[taskIndex].status = 'completed';
                currentChecklistData.tasks[taskIndex].notes = notes;
                await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
                completionNotesModal.hide();
                renderTaskList();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi hoàn thành công việc.");
        }
    }

    function editTaskName(taskId) {
        const task = currentChecklistData.tasks.find(t => t.id === taskId);
        if (!task) return;
        
        const taskElement = document.querySelector(`.list-group-item:has(.acc-checklist-editable:contains("${task.name}"))`);
        if (!taskElement) return;
        
        const editableElement = taskElement.querySelector('.acc-checklist-editable');
        const originalContent = editableElement.innerHTML;
        
        editableElement.innerHTML = `
            <input type="text" class="acc-checklist-edit-input" value="${task.name}">
            <div class="acc-checklist-edit-buttons">
                <button class="btn btn-success btn-sm" onclick="saveTaskName(${taskId}, this)"><i class="bi bi-check"></i> Lưu</button>
                <button class="btn btn-secondary btn-sm" onclick="cancelTaskNameEdit(this, '${task.name.replace(/'/g, "\\'")}')"><i class="bi bi-x"></i> Hủy</button>
            </div>
        `;
        
        const input = editableElement.querySelector('input');
        input.focus();
        input.select();
    }

    async function saveTaskName(taskId, button) {
        const input = button.parentElement.parentElement.querySelector('input');
        const newName = input.value.trim();
        
        if (!newName) {
            alert('Tên công việc không được để trống.');
            return;
        }
        
        try {
            const taskIndex = currentChecklistData.tasks.findIndex(task => task.id === taskId);
            if (taskIndex !== -1) {
                currentChecklistData.tasks[taskIndex].name = newName;
                await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
                renderTaskList();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi cập nhật tên công việc.");
        }
    }

    function cancelTaskNameEdit(button, originalName) {
        const editableElement = button.parentElement.parentElement;
        editableElement.innerHTML = originalName;
    }

    function editChecklistName(coordinatorId, currentName, type) {
        const newName = prompt('Nhập tên mới:', currentName);
        if (newName && newName.trim() && newName !== currentName) {
            updateChecklistName(coordinatorId, newName.trim(), type);
        }
    }

    async function updateChecklistName(coordinatorId, newName, type) {
        try {
            const newId = slugify(newName);
            const ref = database.ref(`checklists/${type}/${newId}`);
            const snapshot = await ref.once('value');
            if (snapshot.exists() && coordinatorId !== newId) {
                alert('Tên này đã tồn tại. Vui lòng chọn tên khác.');
                return;
            }
            const currentData = currentChecklistData;
            currentData.coordinatorName = newName;
            if (coordinatorId !== newId) {
                await database.ref(`checklists/${type}/${newId}`).set(currentData);
                await database.ref(`checklists/${type}/${coordinatorId}`).remove();
                currentCoordinatorId = newId;
            } else {
                await database.ref(`checklists/${type}/${coordinatorId}`).update({ coordinatorName: newName });
            }
            if (type === checklistType && coordinatorId === currentCoordinatorId) {
                document.getElementById('acc-checklist-mainAppModalLabel').innerHTML = `<i class="bi bi-person-fill"></i> Checklist của: <strong>${newName}</strong> <button class="btn btn-outline-primary btn-sm ms-2" onclick="editChecklistName('${currentCoordinatorId}', '${newName}', '${checklistType}')"><i class="bi bi-pencil-fill"></i> Sửa tên</button>`;
                document.getElementById('acc-checklist-mainTitle').innerHTML = `<i class="bi bi-person-fill"></i> Checklist của: <strong>${newName}</strong>`;
            }
            if (type === 'coordinator') {
                loadCoordinatorList();
            } else {
                loadSOPList();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi cập nhật tên.");
        }
    }

    function confirmDeleteCoordinator(coordinatorId, coordinatorName, type) {
        document.getElementById('acc-checklist-deleteMessage').innerText = `Bạn có chắc chắn muốn xóa checklist của "${coordinatorName}" không? Hành động này không thể hoàn tác.`;
        document.getElementById('acc-checklist-confirmDeleteBtn').onclick = () => deleteCoordinator(coordinatorId, type);
        deleteConfirmModal.show();
    }

    async function deleteCoordinator(coordinatorId, type) {
        try {
            await database.ref(`checklists/${type}/${coordinatorId}`).remove();
            deleteConfirmModal.hide();
            if (type === 'coordinator') {
                loadCoordinatorList();
            } else {
                loadSOPList();
            }
            if (currentCoordinatorId === coordinatorId) {
                mainAppModal.hide();
                selectionModal.show();
            }
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi xóa checklist.");
        }
    }

    function deleteTask(taskId) {
        if (confirm('Bạn có chắc chắn muốn xóa công việc này không?')) {
            performDeleteTask(taskId);
        }
    }

    async function performDeleteTask(taskId) {
        try {
            currentChecklistData.tasks = currentChecklistData.tasks.filter(task => task.id !== taskId);
            await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
            renderTaskList();
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi xóa công việc.");
        }
    }

    function openAddTaskModal() {
        const categorySelect = document.getElementById('acc-checklist-taskCategory');
        categorySelect.innerHTML = '';
        const categories = [...new Set(currentChecklistData.tasks.map(task => task.category))];
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
        document.getElementById('acc-checklist-taskName').value = '';
        document.getElementById('acc-checklist-taskDeadline').value = '';
        addTaskModal.show();
    }

    async function addTask() {
        const nameInput = document.getElementById('acc-checklist-taskName');
        const categorySelect = document.getElementById('acc-checklist-taskCategory');
        const deadlineInput = document.getElementById('acc-checklist-taskDeadline');
        const name = nameInput.value.trim();
        const category = categorySelect.value;
        const deadline = deadlineInput.value;
        if (!name) { alert('Vui lòng nhập tên công việc.'); return; }
        if (!category) { alert('Vui lòng chọn phân loại.'); return; }
        try {
            const newTaskId = currentChecklistData.tasks.length > 0 ? Math.max(...currentChecklistData.tasks.map(task => task.id)) + 1 : 1;
            const newTask = {
                id: newTaskId,
                category: category,
                name: name,
                status: 'not-started',
                notes: '',
                deadline: deadline
            };
            currentChecklistData.tasks.push(newTask);
            await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
            addTaskModal.hide();
            renderTaskList();
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi thêm công việc.");
        }
    }

    function generateReport() {
        if (!currentChecklistData || !currentChecklistData.tasks || currentChecklistData.tasks.length === 0) {
            document.getElementById('acc-checklist-reportContent').innerHTML = '<p class="text-center text-muted">Chưa có dữ liệu để tạo báo cáo.</p>';
            return;
        }
        const completedTasks = currentChecklistData.tasks.filter(task => task.status === 'completed');
        const inProgressTasks = currentChecklistData.tasks.filter(task => task.status === 'in-progress');
        const notStartedTasks = currentChecklistData.tasks.filter(task => task.status === 'not-started');
        const totalTasks = currentChecklistData.tasks.length;
        const progressPercentage = Math.round((completedTasks.length / totalTasks) * 100);
        let report = `BÁO CÁO TIẾN ĐỘ CHECKLIST - ${currentChecklistData.coordinatorName.toUpperCase()}\n`;
        report += `Thời gian: ${new Date().toLocaleDateString('vi-VN')}\n`;
        report += `Tổng số công việc: ${totalTasks}\n`;
        report += `Tiến độ tổng thể: ${progressPercentage}%\n\n`;
        report += `=== CÔNG VIỆC HOÀN THÀNH (${completedTasks.length}/${totalTasks}) ===\n`;
        completedTasks.forEach(task => {
            report += `✓ ${task.name}\n`;
            if (task.notes) report += `   Ghi chú: ${task.notes}\n`;
            if (task.deadline) report += `   Hạn: ${task.deadline}\n`;
            report += '\n';
        });
        report += `\n=== CÔNG VIỆC ĐANG THỰC HIỆN (${inProgressTasks.length}/${totalTasks}) ===\n`;
        inProgressTasks.forEach(task => {
            report += `↻ ${task.name}\n`;
            if (task.notes) report += `   Ghi chú: ${task.notes}\n`;
            if (task.deadline) report += `   Hạn: ${task.deadline}\n`;
            report += '\n';
        });
        report += `\n=== CÔNG VIỆC CHƯA BẮT ĐẦU (${notStartedTasks.length}/${totalTasks}) ===\n`;
        notStartedTasks.forEach(task => {
            report += `✗ ${task.name}\n`;
            if (task.notes) report += `   Ghi chú: ${task.notes}\n`;
            if (task.deadline) report += `   Hạn: ${task.deadline}\n`;
            report += '\n';
        });
        document.getElementById('acc-checklist-reportContent').innerText = report;
    }

    function copyReport() {
        const reportContent = document.getElementById('acc-checklist-reportContent').innerText;
        navigator.clipboard.writeText(reportContent).then(() => {
            alert('Đã sao chép báo cáo vào clipboard!');
        }).catch(err => {
            console.error('Lỗi khi sao chép:', err);
            alert('Không thể sao chép báo cáo.');
        });
    }

    function confirmRefreshChecklist() {
        if (confirm('Bạn có chắc chắn muốn làm mới checklist cho kỳ mới? Tất cả trạng thái sẽ được đặt lại "Chưa làm".')) {
            refreshChecklist();
        }
    }

    async function refreshChecklist() {
        try {
            currentChecklistData.tasks.forEach(task => {
                task.status = 'not-started';
                task.notes = '';
            });
            await database.ref(`checklists/${checklistType}/${currentCoordinatorId}/tasks`).set(currentChecklistData.tasks);
            renderTaskList();
            alert('Đã làm mới checklist cho kỳ mới!');
        } catch (error) {
            console.error("Lỗi:", error);
            alert("Đã xảy ra lỗi khi làm mới checklist.");
        }
    }

    function backToSelection() {
        mainAppModal.hide();
        selectionModal.show();
    }

    function slugify(text) {
        return text.toString().toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^\w\-]+/g, '')
            .replace(/\-\-+/g, '-')
            .replace(/^-+/, '')
            .replace(/-+$/, '');
    }

    // Thêm sự kiện cho modal báo cáo
    document.getElementById('acc-checklist-reportModal').addEventListener('show.bs.modal', generateReport);
    </script>
</body>
</html>
